-- CTE for a clean, de-duplicated mapping of skill groups to clients
WITH SkillGroupAndClient AS (
    SELECT
        sgk.SkillGroupID,
        sgk.SkillGroupNm,
        sgk.MRDomainID,
        ck.Client,
        ck.Id AS client_id,
        ck.`Business Unit` AS bu
    FROM
        `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_skillgroupkey` AS sgk
    JOIN
        `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_client_key` AS ck ON sgk.ClientID = ck.Id
    WHERE
        ck.`Business Unit` = 'Answerlink'
        AND ck.Client = 'Matrix 1'
    -- De-duplicate to ensure one definitive record per skill group
    QUALIFY ROW_NUMBER() OVER(PARTITION BY sgk.SkillGroupID) = 1
),

-- CTE to pre-aggregate the raw interval metrics BEFORE joining any other tables
AggregatedMetrics AS (
    SELECT
        asgi.SkillTargetID,
        DATE_TRUNC(DATE(DATETIME(asgi.DateTime, 'America/Chicago')), MONTH) AS Month,
        SUM(COALESCE(asgi.CallsHandled, 0)) AS CallsHandled,
        SUM(COALESCE(asgi.RouterCallsAbandQ, 0)) AS RouterCallsAbandQ,
        SUM(COALESCE(asgi.HandledCallsTime, 0)) AS HandledCallsTime
    FROM
        `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_cisco_skill_group_interval` AS asgi
    JOIN
        `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_cisco_skill_group` AS sg ON asgi.SkillTargetID = sg.SkillTargetID
    WHERE
        DATE(DATETIME(asgi.DateTime, 'America/Chicago')) BETWEEN '2025-09-01' AND '2025-09-30'
    GROUP BY
        1, 2
)

-- Final SELECT joining the correctly pre-aggregated data with the dimension data
SELECT
    agg.Month,
    sgc.bu,
    sgc.client,
    sgc.client_id,
    sgc.SkillGroupID AS SkillTargetID,
    sgc.SkillGroupNm,
    CASE
        WHEN sgc.MRDomainID = 5000 THEN 'Chat'
        WHEN sgc.MRDomainID = 1 OR sgc.MRDomainID IS NULL THEN 'Phone'
    END AS VolumeType,
    agg.CallsHandled,
    agg.RouterCallsAbandQ,
    (agg.CallsHandled + agg.RouterCallsAbandQ) AS CallsOffered,
    agg.HandledCallsTime
FROM
    AggregatedMetrics AS agg
JOIN
    SkillGroupAndClient AS sgc ON agg.SkillTargetID = sgc.SkillGroupID
WHERE
    (sgc.MRDomainID IN (1, 5000) OR sgc.MRDomainID IS NULL)
ORDER BY
    agg.Month,
    sgc.client_id
