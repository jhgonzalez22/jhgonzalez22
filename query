-- 1) One clean mapping row per SkillTargetID
WITH SkillGroupAndClient AS (
  SELECT
    sgk.SkillGroupID,            -- equals SkillTargetID
    sgk.SkillGroupNm,
    sgk.MRDomainID,
    ck.Client,
    ck.Id AS client_id,
    ck.`Business Unit` AS bu
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_skillgroupkey` AS sgk
  JOIN `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_client_key`   AS ck
    ON sgk.ClientID = ck.Id
  WHERE
    ck.`Business Unit` = 'Answerlink'
    AND ck.Client = 'Matrix 1'
  QUALIFY ROW_NUMBER() OVER (PARTITION BY sgk.SkillGroupID) = 1
),

-- 2) De-duplicate intervals at the intended grain BEFORE any sums
--    If the table has multiple rows per (SkillTargetID, DateTime), keep one.
IntervalsDedup AS (
  SELECT
    asgi.SkillTargetID,
    asgi.DateTime,
    -- Use MAX() (or MIN()) across dup rows to collapse; values should be identical for true dupes
    MAX(COALESCE(asgi.CallsHandled, 0))        AS CallsHandled,
    MAX(COALESCE(asgi.RouterCallsAbandQ, 0))   AS RouterCallsAbandQ,
    MAX(COALESCE(asgi.HandledCallsTime, 0))    AS HandledCallsTime
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_cisco_skill_group_interval` AS asgi
  WHERE DATE(DATETIME(asgi.DateTime, 'America/Chicago')) BETWEEN '2025-09-01' AND '2025-09-30'
  GROUP BY 1,2
),

-- 3) Aggregate to Month AFTER dedup
AggregatedMetrics AS (
  SELECT
    SkillTargetID,
    DATE_TRUNC(DATE(DATETIME(DateTime, 'America/Chicago')), MONTH) AS Month,
    SUM(CallsHandled)        AS CallsHandled,
    SUM(RouterCallsAbandQ)   AS RouterCallsAbandQ,
    SUM(HandledCallsTime)    AS HandledCallsTime
  FROM IntervalsDedup
  GROUP BY 1,2
)

-- 4) Join once to the clean map
SELECT
  agg.Month,
  sgc.bu,
  sgc.client,
  sgc.client_id,
  sgc.SkillGroupID AS SkillTargetID,
  sgc.SkillGroupNm,
  CASE
    WHEN sgc.MRDomainID = 5000 THEN 'Chat'
    WHEN sgc.MRDomainID = 1 OR sgc.MRDomainID IS NULL THEN 'Phone'
  END AS VolumeType,
  agg.CallsHandled,
  agg.RouterCallsAbandQ,
  (agg.CallsHandled + agg.RouterCallsAbandQ) AS CallsOffered,
  agg.HandledCallsTime
FROM AggregatedMetrics AS agg
JOIN SkillGroupAndClient AS sgc
  ON agg.SkillTargetID = sgc.SkillGroupID
WHERE (sgc.MRDomainID IN (1, 5000) OR sgc.MRDomainID IS NULL)
ORDER BY agg.Month, sgc.client_id;
