-- 1) One clean row per SkillTargetID â†’ client mapping
WITH SkillGroupAndClient AS (
  SELECT
    sgk.SkillGroupID,            -- equals SkillTargetID
    sgk.SkillGroupNm,
    sgk.MRDomainID,
    ck.Client,
    ck.Id AS client_id,
    ck.`Business Unit` AS bu
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_skillgroupkey` AS sgk
  JOIN `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_client_key`   AS ck
    ON sgk.ClientID = ck.Id
  WHERE
    ck.`Business Unit` = 'Answerlink'
    AND ck.Client = 'Matrix 1'
  QUALIFY ROW_NUMBER() OVER (PARTITION BY sgk.SkillGroupID ORDER BY sgk.SkillGroupID) = 1
),

-- 2) Pre-aggregate intervals WITHOUT any dimensional joins
AggregatedMetrics AS (
  SELECT
    asgi.SkillTargetID,
    DATE_TRUNC(DATE(DATETIME(asgi.DateTime, 'America/Chicago')), MONTH) AS Month,
    SUM(COALESCE(asgi.CallsHandled,        0)) AS CallsHandled,
    SUM(COALESCE(asgi.RouterCallsAbandQ,   0)) AS RouterCallsAbandQ,
    SUM(COALESCE(asgi.HandledCallsTime,    0)) AS HandledCallsTime
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_cisco_skill_group_interval` AS asgi
  WHERE DATE(DATETIME(asgi.DateTime, 'America/Chicago')) BETWEEN '2025-09-01' AND '2025-09-30'
  GROUP BY 1,2
)

-- 3) Join once to the de-duped map
SELECT
  agg.Month,
  sgc.bu,
  sgc.client,
  sgc.client_id,
  sgc.SkillGroupID AS SkillTargetID,
  sgc.SkillGroupNm,
  CASE
    WHEN sgc.MRDomainID = 5000 THEN 'Chat'
    WHEN sgc.MRDomainID = 1 OR sgc.MRDomainID IS NULL THEN 'Phone'
  END AS VolumeType,
  agg.CallsHandled,
  agg.RouterCallsAbandQ,
  (agg.CallsHandled + agg.RouterCallsAbandQ) AS CallsOffered,
  agg.HandledCallsTime
FROM AggregatedMetrics AS agg
JOIN SkillGroupAndClient AS sgc
  ON agg.SkillTargetID = sgc.SkillGroupID
WHERE (sgc.MRDomainID IN (1, 5000) OR sgc.MRDomainID IS NULL)
ORDER BY agg.Month, sgc.client_id;

---------------------------

WITH SkillGroupAndClient AS (
  SELECT
    sgk.SkillGroupID,
    sgk.MRDomainID,
    ck.Client,
    ck.Id AS client_id,
    ck.`Business Unit` AS bu
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_skillgroupkey` AS sgk
  JOIN `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_client_key`   AS ck
    ON sgk.ClientID = ck.Id
  WHERE ck.`Business Unit` = 'Answerlink' AND ck.Client = 'Matrix 1'
  QUALIFY ROW_NUMBER() OVER (PARTITION BY sgk.SkillGroupID) = 1
),

Joined AS (
  SELECT
    DATE_TRUNC(DATE(DATETIME(asgi.DateTime, 'America/Chicago')), MONTH) AS Month,
    sgc.client,
    sgc.client_id,
    sgc.bu,
    sgc.MRDomainID,
    COALESCE(asgi.CallsHandled, 0)      AS CallsHandled,
    COALESCE(asgi.RouterCallsAbandQ, 0) AS RouterCallsAbandQ,
    COALESCE(asgi.HandledCallsTime, 0)  AS HandledCallsTime
  FROM `clgx-taxbi-reg-bf03.tax_clnt_svcs.cc_cisco_skill_group_interval` AS asgi
  JOIN SkillGroupAndClient AS sgc
    ON asgi.SkillTargetID = sgc.SkillGroupID
  WHERE DATE(DATETIME(asgi.DateTime, 'America/Chicago')) BETWEEN '2025-09-01' AND '2025-09-30'
)

SELECT
  Month,
  bu,
  client,
  client_id,
  CASE
    WHEN MRDomainID = 5000 THEN 'Chat'
    WHEN MRDomainID = 1 OR MRDomainID IS NULL THEN 'Phone'
  END AS VolumeType,
  SUM(CallsHandled)                         AS CallsHandled,
  SUM(RouterCallsAbandQ)                    AS RouterCallsAbandQ,
  SUM(CallsHandled + RouterCallsAbandQ)     AS CallsOffered,
  SUM(HandledCallsTime)                     AS HandledCallsTime
FROM Joined
WHERE (MRDomainID IN (1, 5000) OR MRDomainID IS NULL)
GROUP BY 1,2,3,4,5
ORDER BY Month, client_id;



